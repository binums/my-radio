# Development Docker Compose configuration for Radio Calico
# Includes hot-reload, test database, and development tools
version: '3.8'

services:
  # PostgreSQL Database (Production)
  postgres:
    image: postgres:16-alpine
    container_name: radiocalico-postgres-dev
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-devpassword}
      POSTGRES_DB: ${DB_NAME:-prototype_db}
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ./docker/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - radiocalico-dev-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-admin} -d ${DB_NAME:-prototype_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "5433:5432"  # Different port to avoid conflicts with local PostgreSQL

  # PostgreSQL Test Database
  postgres-test:
    image: postgres:16-alpine
    container_name: radiocalico-postgres-test
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${TEST_DB_USER:-admin}
      POSTGRES_PASSWORD: ${TEST_DB_PASSWORD:-devpassword}
      POSTGRES_DB: ${TEST_DB_NAME:-prototype_db_test}
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./docker/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - radiocalico-dev-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${TEST_DB_USER:-admin} -d ${TEST_DB_NAME:-prototype_db_test}"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "5434:5432"  # Separate port for test database

  # Radio Calico Application (Development)
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: radiocalico-app-dev
    restart: unless-stopped
    environment:
      NODE_ENV: development
      PORT: ${PORT:-3000}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${DB_USER:-admin}
      DB_PASSWORD: ${DB_PASSWORD:-devpassword}
      DB_NAME: ${DB_NAME:-prototype_db}
      TEST_DB_HOST: postgres-test
      TEST_DB_PORT: 5432
      TEST_DB_USER: ${TEST_DB_USER:-admin}
      TEST_DB_PASSWORD: ${TEST_DB_PASSWORD:-devpassword}
      TEST_DB_NAME: ${TEST_DB_NAME:-prototype_db_test}
    volumes:
      # Mount source code for hot-reload
      - ./server.js:/app/server.js:ro
      - ./public:/app/public:ro
      - ./tests:/app/tests:ro
      # Mount node_modules as volume to persist across rebuilds
      - node_modules:/app/node_modules
    ports:
      - "${PORT:-3000}:3000"
      - "9229:9229"  # Node.js debugging port
    depends_on:
      postgres:
        condition: service_healthy
      postgres-test:
        condition: service_healthy
    networks:
      - radiocalico-dev-network
    command: npm start
    # Enable interactive terminal for debugging
    stdin_open: true
    tty: true

networks:
  radiocalico-dev-network:
    driver: bridge

volumes:
  postgres_dev_data:
    driver: local
  postgres_test_data:
    driver: local
  node_modules:
    driver: local
